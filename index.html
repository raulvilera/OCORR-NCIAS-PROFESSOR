<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorr√™ncias - 2025</title>

  <!-- jsPDF para gera√ß√£o local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
      color:#fff; font-weight:500; padding:18px;
    }
    .app{max-width:1400px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    
    /* HEADER */
    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:18px;border-radius:14px;
      background: linear-gradient(90deg, rgba(15,32,39,0.95), rgba(32,58,67,0.95));
      box-shadow:0 8px 30px rgba(0,0,0,0.25);
      border-bottom: 3px solid #00b4d8;
    }
    header h1{
      font-size:24px;
      background: linear-gradient(90deg, #00b4d8, #90e0ef);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin:0;
    }
    .header-controls{display:flex;gap:10px;align-items:center}
    
    /* CARDS */
    .card{
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      padding:24px;
      border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,0.15);
    }
    
    /* LAYOUT */
    .flex{display:flex;gap:18px;align-items:flex-start}
    .col{display:flex;flex-direction:column;gap:12px}
    label{display:block;margin-bottom:6px;font-size:13px;color:#90e0ef;font-weight:600}
    
    /* CAMPOS DE ENTRADA */
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      padding:12px 16px;
      border-radius:8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.08);
      font-weight:500;
      font-size:14px;
      color:#fff;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    input[type="password"]:focus,
    select:focus,
    textarea:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: #00b4d8;
      box-shadow: 0 0 0 2px rgba(0,180,216,0.2);
      background: rgba(255,255,255,0.12);
    }
    
    input[type="text"]::placeholder,
    input[type="email"]::placeholder,
    input[type="password"]::placeholder,
    textarea::placeholder {
      color: rgba(255,255,255,0.5);
    }
    
    /* DIMENS√ïES ESPEC√çFICAS DOS CAMPOS */
    #serie_gestao, #turma_select { width: 200px; }
    #aluno_gestao, #professor_select { width: 250px; }
    #ra_gestao { width: 120px; }
    #professor_gestao, #disciplina_gestao { width: 220px; }
    #classificacao_gestao { width: 160px; }
    #dataRetorno_gestao, #data_prof { width: 150px; }
    #alunos_selected_input { width: 350px; }
    
    /* TEXTAREAS */
    textarea{
      min-height:120px;
      resize:vertical;
      padding-top:12px;
      width: 100%;
    }
    
    /* BOT√ïES */
    button{
      cursor:pointer;
      border:none;
      padding:12px 20px;
      border-radius:8px;
      font-weight:600;
      font-size:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
      white-space: nowrap;
      transition: all 0.3s ease;
    }
    
    .btn-primary{
      background:linear-gradient(90deg,#0077b6,#00b4d8);
      color:#fff;
    }
    .btn-primary:hover{
      background:linear-gradient(90deg,#00b4d8,#0077b6);
      transform: translateY(-2px);
      box-shadow:0 8px 20px rgba(0,180,216,0.3);
    }
    
    .btn-danger{
      background:linear-gradient(90deg,#e63946,#ff4d6d);
      color:#fff;
    }
    .btn-danger:hover{
      background:linear-gradient(90deg,#ff4d6d,#e63946);
      transform: translateY(-2px);
      box-shadow:0 8px 20px rgba(255,77,109,0.3);
    }
    
    .btn-success{
      background:linear-gradient(90deg,#2a9d8f,#4cc9f0);
      color:#fff;
    }
    .btn-success:hover{
      background:linear-gradient(90deg,#4cc9f0,#2a9d8f);
      transform: translateY(-2px);
      box-shadow:0 8px 20px rgba(76,201,240,0.3);
    }
    
    .btn-secondary{
      background:linear-gradient(90deg,#6c757d,#adb5bd);
      color:#fff;
    }
    .btn-secondary:hover{
      background:linear-gradient(90deg,#adb5bd,#6c757d);
      transform: translateY(-2px);
    }
    
    /* T√çTULOS */
    .subtitle{
      font-size:16px;
      color:#90e0ef;
      margin-bottom:12px;
      font-weight:600;
      border-bottom: 2px solid rgba(0,180,216,0.3);
      padding-bottom: 8px;
    }
    
    /* LOGIN UNIFICADO */
    .login-container {
      max-width: 480px;
      margin: 0 auto;
      text-align: center;
    }
    
    .login-logo {
      font-size: 32px;
      margin-bottom: 24px;
      background: linear-gradient(90deg, #00b4d8, #90e0ef);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
    }
    
    .login-description {
      color: rgba(255,255,255,0.7);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    
    .login-form {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 32px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .login-input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    .login-input-group label {
      display: block;
      margin-bottom: 8px;
      color: #90e0ef;
    }
    
    .login-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      justify-content: center;
    }
    
    /* HIST√ìRICO */
    .historyList{
      max-height:420px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-right:6px
    }
    
    .historyItem{
      background:rgba(255,255,255,0.05);
      border-left: 4px solid #00b4d8;
      padding:16px;
      border-radius:8px;
      color:#fff;
    }
    
    .historyItem .meta{
      font-size:13px;
      color:#dbefff;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    
    .historyItem .desc{
      margin-top:8px;
      color:#e7f7ff;
      font-weight:500;
      font-size:14px;
      line-height: 1.5;
    }
    
    /* MODAL */
    .modal-root{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.7);
      z-index:2000;
      backdrop-filter: blur(5px);
    }
    
    .modal{
      width:92%;
      max-width:780px;
      background: #1e3a47;
      color:#fff;
      border-radius:16px;
      padding:24px;
      max-height:84vh;
      overflow:auto;
      border: 1px solid rgba(0,180,216,0.3);
    }
    
    /* PILLS */
    .pill{
      background:linear-gradient(90deg,#2a5298,#3a6bd1);
      color:#fff;
      padding:6px 12px;
      border-radius:999px;
      font-weight:600;
      display:inline-block;
    }
    
    /* UTILIDADES */
    .muted{opacity:.9;font-weight:500;color:#e7f7ff}
    .qnum{color:#ff9e00;font-weight:700}
    
    /* FORMUL√ÅRIOS */
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    
    .form-group {
      display: flex;
      flex-direction:column;
      flex: 1 1 auto;
      min-width: 150px;
    }
    
    /* IRREGULARIDADES */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
    }
    
    .checkbox-item {
      background: rgba(255,255,255,0.1);
      color: #fff;
      padding: 8px 12px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      white-space: nowrap;
      transition: all 0.3s ease;
    }
    
    .checkbox-item:hover {
      background: rgba(0,180,216,0.3);
    }
    
    .checkbox-item input {
      margin-right: 8px;
    }
    
    /* NOTIFICA√á√ïES */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      max-width: 400px;
    }
    
    .notification.success {
      background: linear-gradient(90deg, rgba(42,157,143,0.9), rgba(76,201,240,0.9));
      border-left: 4px solid #2a9d8f;
    }
    
    .notification.error {
      background: linear-gradient(90deg, rgba(230,57,70,0.9), rgba(255,77,109,0.9));
      border-left: 4px solid #e63946;
    }
    
    .notification.info {
      background: linear-gradient(90deg, rgba(0,119,182,0.9), rgba(0,180,216,0.9));
      border-left: 4px solid #0077b6;
    }
    
    /* LOADER */
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader{
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,0.2);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
      display:inline-block
    }
    
    /* RESPONSIVIDADE */
    @media(max-width:1200px){
      .app{max-width:95%}
    }
    
    @media(max-width:980px){
      .flex{flex-direction:column}
      header{flex-direction:column;gap:12px;align-items:flex-start}
      .form-row {flex-direction: column;}
      
      input[type="text"],input[type="email"],input[type="password"],
      select,textarea,input[type="date"] {
        width: 100% !important;
      }
      
      .form-group {width: 100%;}
      #alunos_selected_input {width: 100% !important;}
    }
    
    @media(max-width:768px){
      body{padding:12px;}
      .app{gap:12px;}
      .card{padding:20px;}
      .login-actions {flex-direction: column;}
      .login-actions button {width: 100%;}
    }
    
    @media(max-width:480px){
      button{padding:10px 16px;font-size:13px;}
      .historyItem .meta{flex-direction:column;align-items:flex-start;gap:6px;}
      header h1 {font-size: 20px;}
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- HEADER -->
    <header>
      <h1>2025 ‚Äî Sistema de Ocorr√™ncias Escolares</h1>
      <div class="header-controls">
        <div id="userDisplay" class="muted">N√£o autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- TELA DE LOGIN UNIFICADA -->
    <div id="loginScreen" class="card" style="display:block">
      <div class="login-container">
        <div class="login-logo">üìò Sistema Escolar</div>
        <div class="login-description">
          Acesse o sistema de ocorr√™ncias escolares com seu e-mail institucional.
          O sistema detectar√° automaticamente se voc√™ √© da gest√£o ou professor.
        </div>
        
        <div class="login-form">
          <div class="login-input-group">
            <label for="emailLogin">E-mail Institucional</label>
            <input id="emailLogin" type="email" placeholder="seu.email@escola.com" class="field-full">
          </div>
          
          <div class="login-input-group">
            <label for="passwordLogin">Senha</label>
            <input id="passwordLogin" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="field-full">
          </div>
          
          <div class="login-actions">
            <button class="btn-primary" onclick="loginUnificado()">Entrar no Sistema</button>
            <button class="btn-secondary" onclick="preencherDemo()">Acesso Demo</button>
          </div>
          
          <p class="muted" style="margin-top:20px;font-size:13px;text-align:center">
            <strong>Credenciais de teste:</strong><br>
            Gest√£o: gestao@escola.com / gestao123<br>
            Professor: professor@escola.com / prof123
          </p>
        </div>
      </div>
    </div>

    <!-- APP PRINCIPAL - GEST√ÉO (oculto inicialmente) -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div class="subtitle">üìã CADASTRO DE OCORR√äNCIA - GEST√ÉO</div>
          <div class="col">
            <!-- S√©rie/Turma -->
            <div class="form-row">
              <div class="form-group">
                <label>S√©rie / Turma</label>
                <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                  <option value="">-- Selecione a turma --</option>
                </select>
              </div>
            </div>
            
            <!-- Aluno e RA -->
            <div class="form-row">
              <div class="form-group">
                <label>Aluno</label>
                <select id="aluno_gestao" onchange="preencherRAGestao(this.value)">
                  <option value="">-- Selecione o aluno --</option>
                </select>
              </div>
              <div class="form-group">
                <label>RA</label>
                <input id="ra_gestao" type="text" readonly>
              </div>
            </div>
            
            <!-- Professor e Disciplina -->
            <div class="form-row">
              <div class="form-group">
                <label>Professor</label>
                <input id="professor_gestao" type="text" placeholder="Nome do professor">
              </div>
              <div class="form-group">
                <label>Disciplina</label>
                <input id="disciplina_gestao" type="text" placeholder="Nome da disciplina">
              </div>
            </div>
            
            <!-- Classifica√ß√£o e Data de Retorno -->
            <div class="form-row">
              <div class="form-group">
                <label>Classifica√ß√£o</label>
                <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                  <option value="">Selecione</option>
                  <option value="OCORR√äNCIA">OCORR√äNCIA</option>
                  <option value="SUSPENS√ÉO">SUSPENS√ÉO</option>
                </select>
              </div>
              <div class="form-group" style="display:none" id="suspensionRow_gestao">
                <label>Data de retorno</label>
                <input id="dataRetorno_gestao" type="date">
              </div>
            </div>
            
            <!-- Descri√ß√£o -->
            <div class="form-row">
              <div class="form-group" style="width: 100%;">
                <label>Descri√ß√£o detalhada</label>
                <textarea id="descricao_gestao" placeholder="Descreva detalhadamente a ocorr√™ncia..."></textarea>
              </div>
            </div>

            <!-- Bot√µes de a√ß√£o -->
            <div class="form-row">
              <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">
                üìù Registrar Ocorr√™ncia
              </button>
              <button class="btn-success" onclick="generatePDFLocal()">
                üìÑ Gerar PDF Local
              </button>
              <button class="btn-secondary" onclick="limparFormularioGestao()">
                üóëÔ∏è Limpar Formul√°rio
              </button>
            </div>

            <!-- Mensagem de sucesso -->
            <div id="successGestao" style="display:none;margin-top:10px;background:linear-gradient(90deg,#2a9d8f,#4cc9f0);padding:12px;border-radius:8px;color:#fff;font-weight:600">
              ‚úÖ Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO GEST√ÉO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">üìä HIST√ìRICO DE OCORR√äNCIAS - GEST√ÉO</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoGestao()">üîÑ Atualizar</button>
            <button class="btn-secondary" onclick="filtrarHistorico('gestao')">üîç Filtrar</button>
          </div>
        </div>
        <div style="margin-top:16px" id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- APP PRINCIPAL - PROFESSOR (oculto inicialmente) -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="flex">
        <div class="card col" style="flex:1">
          <div class="subtitle">üë®‚Äçüè´ REGISTRO DE OCORR√äNCIA - PROFESSOR</div>
          <div class="col">
            <!-- Professor e Turma -->
            <div class="form-row">
              <div class="form-group">
                <label>Professor</label>
                <select id="professor_select"></select>
              </div>
              <div class="form-group">
                <label>Turma</label>
                <select id="turma_select" onchange="onTurmaChange()"></select>
              </div>
            </div>

            <!-- Alunos e Data -->
            <div class="form-row">
              <div class="form-group">
                <label>Alunos envolvidos</label>
                <input id="alunos_selected_input" type="text" readonly 
                       placeholder="Clique para selecionar alunos" 
                       onclick="openStudentsModal()"
                       style="cursor: pointer;">
                <div id="selectedPills" style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px"></div>
              </div>
              <div class="form-group">
                <label>Data da ocorr√™ncia</label>
                <input id="data_prof" type="date">
              </div>
            </div>

            <!-- Irregularidades -->
            <div class="form-row">
              <div class="form-group" style="width: 100%;">
                <label>Irregularidades cometidas</label>
                <div class="checkbox-group">
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Agress√£o"> Agress√£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Danos ao patrim√¥nio"> Danos ao patrim√¥nio</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="N√£o realiza as atividades"> N√£o realiza as atividades</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Saiu da sala sem autoriza√ß√£o"> Saiu da sala sem autoriza√ß√£o</label>
                  <label class="checkbox-item"><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
                </div>
              </div>
            </div>

            <!-- Descri√ß√£o -->
            <div class="form-row">
              <div class="form-group" style="width: 100%;">
                <label>Descri√ß√£o detalhada</label>
                <textarea id="descricao_prof" placeholder="Descreva detalhadamente a ocorr√™ncia..."></textarea>
              </div>
            </div>

            <!-- Bot√µes de a√ß√£o -->
            <div class="form-row">
              <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">
                üìù Registrar Ocorr√™ncia
              </button>
              <button class="btn-danger" onclick="clearProfessorForm()">
                üóëÔ∏è Limpar Formul√°rio
              </button>
            </div>

            <!-- Mensagem de sucesso -->
            <div id="successProfessor" style="display:none;margin-top:10px;background:linear-gradient(90deg,#2a9d8f,#4cc9f0);padding:12px;border-radius:8px;color:#fff;font-weight:600">
              ‚úÖ Ocorr√™ncia registrada com sucesso!
            </div>
          </div>
        </div>
      </div>

      <!-- HIST√ìRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="subtitle">üìä HIST√ìRICO DE OCORR√äNCIAS - PROFESSOR</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-primary" onclick="carregarHistoricoProfessor()">üîÑ Atualizar</button>
            <button class="btn-secondary" onclick="filtrarHistorico('professor')">üîç Filtrar</button>
          </div>
        </div>
        <div style="margin-top:16px" id="historyListProfessor" class="historyList"></div>
      </div>
    </div>

    <!-- MODAL SELE√á√ÉO ALUNOS -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <strong style="font-size:18px">üë• Selecionar Alunos</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-weight:700;cursor:pointer;font-size:20px;color:#fff">‚úï</button>
        </header>

        <div>
          <input id="studentSearch" type="text" placeholder="üîç Filtrar alunos pelo nome..." 
                 style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);margin-bottom:16px;background:rgba(255,255,255,0.08);color:#fff">
          <div id="studentList" class="studentList"></div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:20px">
          <button class="btn-primary" onclick="confirmStudents()">‚úÖ Confirmar Sele√ß√£o</button>
          <button class="btn-danger" onclick="closeStudentsModal()">‚ùå Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /*******************************
     * CONFIGURA√á√ïES
     *******************************/
    // LINK APPSCRIPT CORRIGIDO
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzMA2BFpQgGIk455tZt2Xt6YxT6pZsX1SNSse5Jnld0JwL6zl468GnhpJqwc6RVyaEb/exec';
    const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';

    // nomes de abas
    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    // estado
    let allAlunos = [];
    let alunosDaTurmaAtual = [];
    let alunosSelecionados = [];
    let professores = [];
    let turmas = [];
    let currentUserRole = null;
    let alunosComRA = [];

    // inicial
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      carregarTurmasGestao();
      
      // Ajustar largura inicial dos campos
      setTimeout(ajustarLarguraCampos, 200);
      
      // Permitir login com Enter
      document.getElementById('passwordLogin').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          loginUnificado();
        }
      });
    });

    // Fun√ß√£o para ajustar dinamicamente as larguras
    function ajustarLarguraCampos() {
      // Ajustar selects
      const selects = document.querySelectorAll('select');
      selects.forEach(select => {
        if (select.options.length > 0) {
          const temp = document.createElement('span');
          temp.style.visibility = 'hidden';
          temp.style.position = 'absolute';
          temp.style.whiteSpace = 'nowrap';
          temp.style.font = window.getComputedStyle(select).font;
          
          let maxWidth = 0;
          Array.from(select.options).forEach(option => {
            temp.textContent = option.text;
            document.body.appendChild(temp);
            const width = temp.getBoundingClientRect().width;
            maxWidth = Math.max(maxWidth, width);
            document.body.removeChild(temp);
          });
          
          select.style.width = (maxWidth + 50) + 'px';
          select.style.minWidth = '120px';
          select.style.maxWidth = '400px';
        }
      });

      // Ajustar inputs de texto
      const textInputs = document.querySelectorAll('input[type="text"]:not([readonly])');
      textInputs.forEach(input => {
        if (input.value) {
          const temp = document.createElement('span');
          temp.style.visibility = 'hidden';
          temp.style.position = 'absolute';
          temp.style.whiteSpace = 'nowrap';
          temp.style.font = window.getComputedStyle(input).font;
          temp.textContent = input.value;
          document.body.appendChild(temp);
          const width = temp.getBoundingClientRect().width;
          document.body.removeChild(temp);
          
          input.style.width = (width + 40) + 'px';
          input.style.minWidth = '120px';
          input.style.maxWidth = '300px';
        }
      });
    }

    // Fun√ß√£o para exibir notifica√ß√µes
    function showNotification(type, message) {
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => notification.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100px)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    /*******************************
     * LOGIN UNIFICADO
     *******************************/
    function loginUnificado() {
      const email = document.getElementById('emailLogin').value.trim();
      const password = document.getElementById('passwordLogin').value.trim();
      
      if (!email || !password) {
        showNotification('error', 'Por favor, preencha e-mail e senha.');
        return;
      }
      
      // Simula√ß√£o de autentica√ß√£o
      if (email === 'gestao@escola.com' && password === 'gestao123') {
        showAppAs('gestao', email);
        showNotification('success', 'Login realizado como Gest√£o!');
      } else if (email === 'professor@escola.com' && password === 'prof123') {
        showAppAs('professor', email);
        showNotification('success', 'Login realizado como Professor!');
      } else {
        showNotification('error', 'E-mail ou senha incorretos. Use as credenciais de demonstra√ß√£o.');
      }
    }
    
    function preencherDemo() {
      const emails = ['gestao@escola.com', 'professor@escola.com'];
      const emailAleatorio = emails[Math.floor(Math.random() * emails.length)];
      
      document.getElementById('emailLogin').value = emailAleatorio;
      document.getElementById('passwordLogin').value = emailAleatorio === 'gestao@escola.com' ? 'gestao123' : 'prof123';
      
      showNotification('info', 'Credenciais de demonstra√ß√£o preenchidas. Clique em "Entrar no Sistema".');
      
      setTimeout(ajustarLarguraCampos, 100);
    }

    function showAppAs(role, email) {
      currentUserRole = role;
      document.getElementById('loginScreen').style.display = 'none';
      
      if (role === 'gestao') {
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
      
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gest√£o)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('btnDownloadPdf').style.display = 'inline-block';
      
      setTimeout(ajustarLarguraCampos, 300);
    }

    function logout() {
      currentUserRole = null;
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'N√£o autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      document.getElementById('btnDownloadPdf').style.display = 'none';
      alunosDaTurmaAtual = []; 
      alunosSelecionados = []; 
      document.getElementById('selectedPills').innerHTML = '';
      
      document.getElementById('emailLogin').value = '';
      document.getElementById('passwordLogin').value = '';
      
      showNotification('info', 'Logout realizado com sucesso!');
    }

    /*******************************
     * Fun√ß√µes espec√≠ficas para a √°rea de gest√£o
     *******************************/
    async function carregarTurmasGestao() {
      try {
        const r = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j = await r.json();
        if(j && j.status === 'success' && Array.isArray(j.classes)) {
          turmas = j.classes;
        } else {
          turmas = Object.keys(_getClassRanges());
        }
        
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
        
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err) {
        console.error('Erro ao carregar turmas (gest√£o):', err);
        turmas = Object.keys(_getClassRanges());
        const turmaSelect = document.getElementById('serie_gestao');
        turmaSelect.innerHTML = '<option value="">-- Selecione a turma --</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t;
          option.textContent = t;
          turmaSelect.appendChild(option);
        });
        
        setTimeout(ajustarLarguraCampos, 100);
      }
    }
    
    async function carregarAlunosPorTurmaGestao(turma) {
      if (!turma) {
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
        document.getElementById('ra_gestao').value = '';
        return;
      }
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        
        if (json.studentsList && Array.isArray(json.studentsList)) {
          alunosComRA = json.studentsList;
        } else if (json.students && Array.isArray(json.students)) {
          alunosComRA = json.students.map(nome => ({ nome, ra: '' }));
        } else {
          alunosComRA = [];
        }
        
        const alunoSelect = document.getElementById('aluno_gestao');
        alunoSelect.innerHTML = '<option value="">-- Selecione o aluno --</option>';
        
        alunosComRA.forEach(aluno => {
          const option = document.createElement('option');
          option.value = aluno.nome;
          option.textContent = aluno.nome;
          option.setAttribute('data-ra', aluno.ra || '');
          alunoSelect.appendChild(option);
        });
        
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err) {
        console.error('Erro ao carregar alunos (gest√£o):', err);
        document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
      }
    }
    
    function preencherRAGestao(nomeAluno) {
      const alunoSelect = document.getElementById('aluno_gestao');
      const selectedOption = alunoSelect.selectedOptions[0];
      const ra = selectedOption ? selectedOption.getAttribute('data-ra') : '';
      document.getElementById('ra_gestao').value = ra || '';
      
      setTimeout(ajustarLarguraCampos, 50);
    }

    /*******************************
     * GET professores & turmas
     *******************************/
    async function carregarProfessoresETurmas() {
      try {
        // professores
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;
        else professores = getFallbackProfessores();

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { 
          const o = document.createElement('option'); 
          o.value = p; 
          o.textContent = p; 
          profSel.appendChild(o); 
        });

        // turmas
        const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j2 = await r2.json();
        if(j2 && j2.status === 'success' && Array.isArray(j2.classes)) turmas = j2.classes;
        else turmas = Object.keys(_getClassRanges());

        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { 
          const o = document.createElement('option'); 
          o.value = t; 
          o.textContent = t; 
          turmaSel.appendChild(o); 
        });
        
        setTimeout(ajustarLarguraCampos, 100);
      } catch(err) {
        console.error('Erro carregar professores/turmas:', err);
        professores = getFallbackProfessores();
        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { 
          const o = document.createElement('option'); 
          o.value = p; 
          o.textContent = p; 
          profSel.appendChild(o); 
        });
        turmas = Object.keys(_getClassRanges());
        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        turmas.forEach(t => { 
          const o = document.createElement('option'); 
          o.value = t; 
          o.textContent = t; 
          turmaSel.appendChild(o); 
        });
        
        setTimeout(ajustarLarguraCampos, 100);
      }
    }

    /*******************************
     * Fun√ß√£o para limpar formul√°rio de gest√£o
     *******************************/
    function limparFormularioGestao() {
      document.getElementById('serie_gestao').value = '';
      document.getElementById('aluno_gestao').innerHTML = '<option value="">-- Selecione o aluno --</option>';
      document.getElementById('ra_gestao').value = '';
      document.getElementById('professor_gestao').value = '';
      document.getElementById('disciplina_gestao').value = '';
      document.getElementById('classificacao_gestao').value = '';
      document.getElementById('descricao_gestao').value = '';
      document.getElementById('dataRetorno_gestao').value = '';
      document.getElementById('suspensionRow_gestao').style.display = 'none';
      showNotification('success', 'Formul√°rio limpo com sucesso!');
      
      setTimeout(ajustarLarguraCampos, 100);
    }

    /*******************************
     * GET students by class
     *******************************/
    async function onTurmaChange() {
      const turma = document.getElementById('turma_select').value;
      if(!turma) { 
        alunosDaTurmaAtual = []; 
        renderStudentList([]); 
        return; 
      }
      await carregarAlunosPorTurma(turma);
      renderStudentList(alunosDaTurmaAtual);
      
      setTimeout(ajustarLarguraCampos, 100);
    }

    async function carregarAlunosPorTurma(turma) {
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        alunosDaTurmaAtual = json.students || json.studentsList || [];
        if(!Array.isArray(alunosDaTurmaAtual)) alunosDaTurmaAtual = [];
      } catch(err) {
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
      }
    }

    /*******************************
     * Modal alunos (professor)
     *******************************/
    function openStudentsModal() {
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0) { 
        showNotification('error', 'Selecione uma turma primeiro para carregar os alunos.'); 
        return; 
      }
      document.getElementById('modalRoot').style.display = 'flex';
      renderStudentList(alunosDaTurmaAtual);
      document.getElementById('studentSearch').value = '';
    }
    
    function closeStudentsModal() { 
      document.getElementById('modalRoot').style.display = 'none'; 
    }

    function renderStudentList(list) {
      const container = document.getElementById('studentList'); 
      container.innerHTML = '';
      
      if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.5)">Nenhum aluno encontrado nesta turma.</div>';
        return;
      }
      
      list.forEach(nome => {
        const row = document.createElement('div'); 
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.alignItems = 'center';
        row.style.padding = '12px';
        row.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
        row.style.transition = 'background 0.3s';
        
        row.onmouseenter = () => row.style.background = 'rgba(255,255,255,0.05)';
        row.onmouseleave = () => row.style.background = 'transparent';
        
        const lbl = document.createElement('div'); 
        lbl.textContent = nome;
        lbl.style.flex = '1';
        
        const cb = document.createElement('input'); 
        cb.type = 'checkbox'; 
        cb.value = nome; 
        cb.checked = alunosSelecionados.includes(nome);
        cb.style.cursor = 'pointer';
        
        cb.onchange = (e) => { 
          if(e.target.checked) { 
            if(!alunosSelecionados.includes(nome)) alunosSelecionados.push(nome); 
          } else {
            alunosSelecionados = alunosSelecionados.filter(x => x !== nome); 
          }
        };
        
        row.appendChild(lbl); 
        row.appendChild(cb); 
        container.appendChild(row);
      });
    }

    function filterStudentList() { 
      const q = document.getElementById('studentSearch').value.toLowerCase(); 
      const filtered = alunosDaTurmaAtual.filter(s => s.toLowerCase().includes(q)); 
      renderStudentList(filtered); 
    }

    function confirmStudents() {
      document.getElementById('alunos_selected_input').value = alunosSelecionados.join(', ');
      const pills = document.getElementById('selectedPills'); 
      pills.innerHTML = '';
      
      if (alunosSelecionados.length === 0) {
        pills.innerHTML = '<div style="color:rgba(255,255,255,0.5);font-style:italic">Nenhum aluno selecionado</div>';
      } else {
        alunosSelecionados.forEach(a => { 
          const el = document.createElement('div'); 
          el.className = 'pill'; 
          el.textContent = a; 
          el.style.marginBottom = '4px';
          pills.appendChild(el); 
        });
      }
      
      closeStudentsModal();
      showNotification('success', `${alunosSelecionados.length} aluno(s) selecionado(s).`);
      
      setTimeout(ajustarLarguraCampos, 100);
    }

    /*******************************
     * Toggle suspens√£o (gest√£o)
     *******************************/
    function toggleSuspension(area) {
      if(area === 'gestao') { 
        const val = document.getElementById('classificacao_gestao').value; 
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENS√ÉO') ? 'flex' : 'none'; 
      }
      
      setTimeout(ajustarLarguraCampos, 50);
    }

    /*******************************
     * POST cadastrar ocorr√™ncia (gest√£o)
     *******************************/
    async function cadastrarOcorrenciaGestao() {
      const alunoSelect = document.getElementById('aluno_gestao');
      const aluno = alunoSelect.value;
      const turmaSelect = document.getElementById('serie_gestao');
      const serie = turmaSelect.value;
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;
      const ra = document.getElementById('ra_gestao').value;

      if(!aluno || !serie || !professor || !disciplina || !classificacao || !descricao) { 
        showNotification('error', 'Preencha todos os campos obrigat√≥rios marcados com *.');
        return; 
      }
      
      if(classificacao === 'SUSPENS√ÉO' && !dataRetorno) { 
        showNotification('error', 'Informe a data de retorno para suspens√£o.');
        return; 
      }

      const payload = {
        sheet: SHEET_GESTAO,
        startRow: 2,
        date: new Date().toISOString().split('T')[0],
        professor: professor,
        studentClass: serie,
        student: aluno,
        ra: ra,
        disciplina: disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      try {
        const resp = await fetch(`${SCRIPT_URL}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await resp.json();
        if(j && j.status === 'success') {
          showNotification('success', 'Ocorr√™ncia registrada com sucesso no sistema!');
          limparFormularioGestao();
          carregarHistoricoGestao();
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err) {
        console.error('Erro POST ocorrencia (gestao):', err);
        showNotification('error', 'Falha na comunica√ß√£o com o servidor. Verifique sua conex√£o.');
      }
    }

    /*******************************
     * POST registrar ocorr√™ncia (professor)
     *******************************/
    async function registrarOcorrenciaProfessor() {
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      
      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0) { 
        showNotification('error', 'Preencha todos os campos obrigat√≥rios e selecione ao menos um aluno.'); 
        return; 
      }
      
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x => x.value);
      const payload = { 
        sheet: SHEET_PROF,
        startRow: 2,
        date: dataOc, 
        professor: professor, 
        studentClass: turma, 
        student: alunosSelecionados.join(', '), 
        irregularities: irregs.join(', '), 
        description: descricao 
      };
      
      try {
        const resp = await fetch(`${SCRIPT_URL}`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(payload) 
        });
        const j = await resp.json();
        if(j && j.status === 'success') {
          showNotification('success', 'Ocorr√™ncia registrada com sucesso no sistema!');
          clearProfessorForm();
          carregarHistoricoProfessor();
        } else {
          showNotification('error', j.message || 'Erro ao registrar ocorr√™ncia!');
        }
      } catch(err) {
        console.error('Erro POST ocorrencia (professor):', err);
        showNotification('error', 'Falha na comunica√ß√£o com o servidor. Verifique sua conex√£o.');
      }
    }

    function clearProfessorForm() {
      document.getElementById('professor_select').value = ''; 
      document.getElementById('turma_select').value = ''; 
      document.getElementById('alunos_selected_input').value = ''; 
      document.getElementById('selectedPills').innerHTML = ''; 
      document.getElementById('descricao_prof').value = ''; 
      alunosSelecionados = []; 
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb => cb.checked = false); 
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      
      setTimeout(ajustarLarguraCampos, 100);
      showNotification('success', 'Formul√°rio limpo com sucesso!');
    }

    /*******************************
     * GET hist√≥rico
     *******************************/
    async function carregarHistoricoGestao() {
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:40px"><div class="loader"></div><div class="muted">Carregando hist√≥rico...</div></div>`;
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        
        if(!ocorrs || ocorrs.length === 0) { 
          container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">Nenhuma ocorr√™ncia registrada ainda.</div>'; 
          return; 
        }

        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const div = document.createElement('div'); 
          div.className = 'historyItem';
          
          const meta = document.createElement('div'); 
          meta.className = 'meta';
          meta.innerHTML = `<div><strong>üìÖ ${date}</strong> ‚Äî üë®‚Äçüè´ <span class="muted">${prof}</span></div>`;
          
          const controls = document.createElement('div');
          controls.style.display = 'flex';
          controls.style.gap = '8px';
          
          const pdfBtn = document.createElement('button');
          pdfBtn.className = 'btn-success'; 
          pdfBtn.style.fontSize = '12px'; 
          pdfBtn.style.padding = '6px 12px';
          pdfBtn.textContent = 'üìÑ PDF';
          pdfBtn.onclick = () => generatePdfFromBackend(id);
          
          const delBtn = document.createElement('button');
          delBtn.className = 'btn-danger'; 
          delBtn.style.fontSize = '12px'; 
          delBtn.style.padding = '6px 12px';
          delBtn.textContent = 'üóëÔ∏è Excluir';
          delBtn.onclick = () => deleteOccurrence(id);

          controls.appendChild(pdfBtn); 
          controls.appendChild(delBtn);
          meta.appendChild(controls);

          const ddesc = document.createElement('div'); 
          ddesc.className = 'desc';
          ddesc.innerHTML = `
            <strong>üë§ Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>üè´ Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>‚ö†Ô∏è Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <div style="margin-top:8px;background:rgba(255,255,255,0.05);padding:8px;border-radius:6px">
            <strong>üìù Descri√ß√£o:</strong><br/>${desc || 'Sem descri√ß√£o'}
            </div>`;

          const idLine = document.createElement('div'); 
          idLine.style.marginTop = '8px'; 
          idLine.style.fontSize = '12px'; 
          idLine.style.opacity = '0.9'; 
          idLine.innerHTML = `üî¢ ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); 
          div.appendChild(ddesc); 
          div.appendChild(idLine);
          container.appendChild(div);
        });
        
        showNotification('success', `Hist√≥rico carregado: ${ocorrs.length} ocorr√™ncia(s)`);
      } catch(err) {
        console.error('Erro carregarHistorico:', err);
        container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">‚ùå Erro ao carregar hist√≥rico. Tente novamente.</div>';
      }
    }

    async function carregarHistoricoProfessor() {
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;gap:8px;padding:40px"><div class="loader"></div><div class="muted">Carregando hist√≥rico...</div></div>`;
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const json = await resp.json();
        const ocorrs = json.occurrences || json.data || [];
        container.innerHTML = '';
        
        if(!ocorrs || ocorrs.length === 0) { 
          container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">Nenhuma ocorr√™ncia registrada ainda.</div>'; 
          return; 
        }

        ocorrs.slice().reverse().forEach(r => {
          const id = r.id || r.ID || r.Id || null;
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';

          const div = document.createElement('div'); 
          div.className = 'historyItem';
          
          const meta = document.createElement('div'); 
          meta.className = 'meta';
          meta.innerHTML = `<div><strong>üìÖ ${date}</strong> ‚Äî üë®‚Äçüè´ <span class="muted">${prof}</span></div>`;
          
          const ddesc = document.createElement('div'); 
          ddesc.className = 'desc';
          ddesc.innerHTML = `
            <strong>üë§ Aluno(s):</strong> ${aluno || 'N/A'}<br/>
            <strong>üè´ Turma:</strong> ${turma || 'N/A'}<br/>
            <strong>‚ö†Ô∏è Irregularidades:</strong> ${irreg || 'N/A'}<br/>
            <div style="margin-top:8px;background:rgba(255,255,255,0.05);padding:8px;border-radius:6px">
            <strong>üìù Descri√ß√£o:</strong><br/>${desc || 'Sem descri√ß√£o'}
            </div>`;

          const idLine = document.createElement('div'); 
          idLine.style.marginTop = '8px'; 
          idLine.style.fontSize = '12px'; 
          idLine.style.opacity = '0.9'; 
          idLine.innerHTML = `üî¢ ID: <span class="qnum">${id}</span>`;

          div.appendChild(meta); 
          div.appendChild(ddesc); 
          div.appendChild(idLine);
          container.appendChild(div);
        });
        
        showNotification('success', `Hist√≥rico carregado: ${ocorrs.length} ocorr√™ncia(s)`);
      } catch(err) {
        console.error('Erro carregarHistorico:', err);
        container.innerHTML = '<div class="muted" style="text-align:center;padding:40px">‚ùå Erro ao carregar hist√≥rico. Tente novamente.</div>';
      }
    }

    /*******************************
     * DELETE ocorr√™ncia
     *******************************/
    async function deleteOccurrence(occurrenceId) {
      if(occurrenceId === null || occurrenceId === undefined) { 
        showNotification('error', 'ID inv√°lido para exclus√£o.'); 
        return; 
      }
      
      if(!confirm(`Tem certeza que deseja excluir a ocorr√™ncia (ID ${occurrenceId})?\nEsta a√ß√£o n√£o pode ser desfeita.`)) return;
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_PROF })
        });
        const j = await resp.json();
        if(j && j.status === 'success') { 
          showNotification('success', 'Ocorr√™ncia exclu√≠da com sucesso!');
          carregarHistoricoGestao(); 
        } else {
          showNotification('error', j.message || 'Erro ao excluir ocorr√™ncia!');
        }
      } catch(err) { 
        console.error('Erro deleteOccurrence:', err); 
        showNotification('error', 'Falha na comunica√ß√£o com o servidor.');
      }
    }

    /*******************************
     * Gera√ß√£o de PDF via backend
     *******************************/
    async function generatePdfFromBackend(occurrenceId) {
      if(!occurrenceId) { 
        showNotification('error', 'ID inv√°lido para gera√ß√£o de PDF.'); 
        return; 
      }
      
      showNotification('info', 'Gerando PDF...');
      
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ occurrenceId, sheet: SHEET_PROF })
        });
        const j = await resp.json();
        if(j && j.status === 'success' && j.pdfUrl) {
          window.open(j.pdfUrl, '_blank');
          showNotification('success', 'PDF gerado com sucesso!');
        } else {
          showNotification('error', j.message || 'Erro ao gerar PDF!');
        }
      } catch(err) {
        console.error('Erro generatePdfFromBackend:', err);
        showNotification('error', 'Falha na comunica√ß√£o com o servidor.');
      }
    }

    /*******************************
     * PDF local
     *******************************/
    function generatePDFLocal() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabe√ßalho
        doc.setFillColor(15, 32, 39);
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.text('Registro de Ocorr√™ncia', 20, 25);
        
        doc.setFontSize(10);
        doc.text('Sistema Escolar - 2025', 20, 32);
        
        // Informa√ß√µes da ocorr√™ncia
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        
        const aluno = document.getElementById('aluno_gestao').value || '';
        const turma = document.getElementById('serie_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const disc = document.getElementById('disciplina_gestao').value || '';
        const classificacao = document.getElementById('classificacao_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        const data = new Date().toLocaleDateString('pt-BR');
        
        let y = 50;
        
        doc.setFontSize(14);
        doc.text('DADOS DA OCORR√äNCIA', 20, y);
        y += 10;
        
        doc.setFontSize(11);
        if(aluno) { doc.text(`Aluno: ${aluno}`, 20, y); y += 7; }
        if(turma) { doc.text(`Turma: ${turma}`, 20, y); y += 7; }
        if(prof) { doc.text(`Professor: ${prof}`, 20, y); y += 7; }
        if(disc) { doc.text(`Disciplina: ${disc}`, 20, y); y += 7; }
        if(classificacao) { doc.text(`Classifica√ß√£o: ${classificacao}`, 20, y); y += 7; }
        doc.text(`Data do registro: ${data}`, 20, y); y += 10;
        
        // Descri√ß√£o
        doc.setFontSize(14);
        doc.text('DESCRI√á√ÉO DETALHADA:', 20, y);
        y += 10;
        
        doc.setFontSize(11);
        const split = doc.splitTextToSize(desc || 'Sem descri√ß√£o', 170);
        doc.text(split, 20, y);
        
        // Rodap√©
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Documento gerado automaticamente pelo Sistema de Ocorr√™ncias Escolares', 20, 280);
        
        doc.save(`ocorrencia_${data.replace(/\//g, '-')}_${aluno.substring(0, 10)}.pdf`);
        showNotification('success', 'PDF gerado e baixado com sucesso!');
      } catch(err) { 
        console.error('Erro gerar PDF local:', err); 
        showNotification('error', 'Erro ao gerar PDF local. Verifique se todos os campos est√£o preenchidos.');
      }
    }

    /*******************************
     * Fun√ß√£o de filtro do hist√≥rico (placeholder)
     *******************************/
    function filtrarHistorico(tipo) {
      showNotification('info', 'Funcionalidade de filtro avan√ßado em desenvolvimento.');
    }

    /*******************************
     * Fun√ß√£o de download de template (placeholder)
     *******************************/
    function downloadDocument() {
      showNotification('info', 'Funcionalidade de download de template em desenvolvimento.');
    }

    /*******************************
     * utilit√°rios / fallbacks
     *******************************/
    function _getClassRanges() { 
      return {
        "6¬∞ ANO A MANHA":"C3:C46","6¬∞ ANO B MANHA":"H3:H46","6¬∞ ANO C MANHA":"M3:M46","6¬∞ ANO D MANHA":"R3:R46",
        "6¬∞ ANO E TARDE":"W3:W46","6¬∞ ANO F TARDE":"AB3:AB46","7¬∞ ANO A TARDE":"AG3:AG46","7¬∞ ANO B TARDE":"AL3:AL46",
        "7¬∞ ANO C TARDE":"AQ3:AQ46","7¬∞ ANO D TARDE":"AV3:AV46","7¬∞ ANO E TARDE":"BA3:BA46","7¬∞ ANO F TARDE":"BF3:BF46",
        "8¬∞ ANO A TARDE":"BK3:BK46","8¬∞ ANO B TARDE":"BP3:BP46","8¬∞ ANO C TARDE":"BU3:BU46","8¬∞ ANO D TARDE":"BZ3:B46",
        "9¬∞ ANO A TARDE":"CE3:CE46","9¬∞ ANO B TARDE":"CJ3:CJ46","9¬∞ ANO C TARDE":"CO3:CO46","9¬∞ ANO D TARDE":"CT3:CT46",
        "1¬™ SERIE A MANHA":"CY3:CY46","1¬™ SERIE B MANHA":"DD3:DD46","1¬™ SERIE C MANHA":"DI3:DI46","1¬™ SERIE D MANHA":"DN3:DN46",
        "1¬™ SERIE E MANHA":"DS3:DS46","1¬™ SERIE F MANHA":"DX3:DX46","1¬™ SERIE G TARDE":"EC3:EC46","1¬™ SERIE H NOITE":"EH3:EH46",
        "1¬™ SERIE I NOITE":"EM3:EM46","2¬™ SERIE A MANHA":"ER3:ER46","2¬™ SERIE B MANHA":"EW3:EW46","2¬™ SERIE C MANHA":"FB3:FB46",
        "2¬™ SERIE D MANHA":"FG3:FG46","2¬™ SERIE E MANHA":"FL3:FL46","2¬™ SERIE F NOITE":"FQ3:FQ46","2¬™ SERIE G NOITE":"FV3:FV46",
        "2¬™ SERIE H NOITE":"GA3:GA46","3¬™ SERIE A MANHA":"GK3:GK46","3¬™ SERIE B MANHA":"GP3:GP46","3¬™ SERIE C MANHA":"GU3:GU46",
        "3¬™ SERIE D NOITE":"GZ3:GZ46","3¬™ SERIE E NOITE":"HE3:HE46","3¬™ SERIE F NOITE":"HJ3:HJ46"
      };
    }

    function getFallbackProfessores() {
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA","AMAURI TEODORO DE OLIVEIRA",
        "ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS","ANTONIO CARLOS DE OLIVEIRA",
        "ANTONIO RAMOS DE ARAUJO","ANTONIO WILTON WANDERLEY CABRAL","AUGUSTO LINO PESSOA NETO","AUREA MARIA DE JESUS MARQUES",
        "CAROLINA PERNOMIAN PARUSSOLOLO","CASSIA OLIVEIRA ANTONIAZI","CLAUDINEIA DE AGUIAR LIMA","DANIEL DE FREITAS ALMEIDA",
        "DANIEL LOPES BARBOSA","DANIELA FERREIRA LIMA","DANIELLE LUCIA BATISTA DE ALMEIDA","EDIANE VIEIRA DA SILVA",
        "EDILEUSA NUNES PEREIRA","EDUARDO HENRIQUE DA FONSECA","ELIANE SANTOS SILVA","ELIAS MONTEIRO DA SILVERA",
        "ELISABETE APARECIDA PIRES","ELZA DE FARIA PEREIRA","EMERSON GABLER DE ALMEIDA","EUZELI ARAUJO DE OLIVEIRA",
        "FABIANO AUGUSTO PIEDADE","FABIO CAMILO","FERNANDO JOSE DA SILVA FILHO","FLAVIA CRISTINA APARECIDA BICHLER",
        "FLAVIO CARDOSO FLEURY","FRANCISCA EDIVANIA DE MORAIS COSTA","GABRIELA SERIGHELLI DE MELO","GELSON DE ALMEIDA BATISTA",
        "GENILTON DE OLIVEIRA SILVA","GIANI CRISTINA DO PRADO","INGRYD CAROLINA SUGUIMOTO VIEIRA","IVANILDES DOS SANTOS OSHIKAWA",
        "JANINA DOS PASSOS BRAGA DE ALMEIDA","JOSE APARECIDO DA SILVA","JUAREZ GOMES DE MAGALHAES FILHO","JUREMA SOLEDADE FURINI SANTOS",
        "KATIUSCIA ALVES BOMFIM","LUANA CAROLINE ALVES LIMA","LUANA DE FREITAS SILVA","LUCIANA NOVAIS CORREIA SANTOS",
        "LUCIANO MOREIRA DE AZEVEDO","MARCIEL DA SILVA","MARIA HELENA CUNHA MORO","MARIA QUIT√âRIA FERREIRA DOS SANTOS",
        "MARINA DA CONCEICAO FRANCISCO SILVA","MAURICIO DE BARROS SANTOS","MICHELE DE PINHO MORAES","MOISES ANTONIO DE BARROS",
        "PAULA ARMANI VILA","PAULO ROBERTO DA SILVA ITO","PEDRO ZANOTTI FILHO","RAUL PEREIRA VILERA JUNIOR",
        "REGIANE CURTI DE SOUZA OLIVEIRA","REGINA DA SILSA CASTRO","RICARDO AMERICO DA SILVA","ROBERTO SALGADO",
        "RODRIGO VIEIRA","ROSANGELA CAFASSO MOREIRA","ROSIMERY DE SOUZA PESSOA","ROSMARA DA SILSA CARDOSO",
        "SANDRA CRISTINA MACEDO MORAES","SELMA GOMES DA SILSA","SERGIO AGRIPINO VILLA NOVA","SOLANGE ALMEIDA DA SILSA",
        "SUZINEIDE SILSA DE FREITAS","THIAGO FABIANO BRITO","TITTO AUGUSTO NASCIMENTO SILSA","VANDERSON HYPPOLITO",
        "VANESSA IVETE GOMES DOS SANTOS","VANIA PENHA DE BARROS","VIVIANE LEAL CAMERA DE MORAES","WILSON RODRIGUES MOTA"
      ];
    }

  </script>
</body>
</html>
